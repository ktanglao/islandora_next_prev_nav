<?php

function next_prev_islandora_view_object_alter(&$object, &$rendered){
  if(in_array('islandora:collectionCModel', $object->models)){
    return;
  }
  else{
    $button = function($target_pid,$target_label,$direction_label){
      $string = "<p>$direction_label, $target_label </p><a href='/islandora/object/$target_pid'><img typeof='foaf:Image' src='/islandora/object/$target_pid/datastream/TN/view' alt=$target_label></a>";
      return $string;
    };

    $index = get_list_isMemberOf($object->id);
    //dpm($index);

    $current_obj_index = function($pid,$array){
      foreach($array as $key => $obj){
        if($obj['object']['value'] == $pid){
          return $key;
        }
      }
    };

    $pos = $current_obj_index($object->id, $index);
    if(count($index) == 1){
      return;
    }
    if($pos == 0){
      $pos_up = $pos + 1;
      $rendered[null]['#markup'] = $rendered[null]['#markup'] . $button($index[$pos_up]['object']['value'],$index[$pos_up]['label']['value'],'next item');
    }
    elseif($pos == count($index)-1){
      $pos_down = $pos - 1;
      $rendered[null]['#markup'] = $rendered[null]['#markup'] .  $button($index[$pos_down]['object']['value'],$index[$pos_down]['label']['value'],'previous item');
    }
    else{
      $pos_down = $pos - 1;
      $pos_up = $pos + 1;    
      $rendered[null]['#markup'] = $rendered[null]['#markup'] . $button($index[$pos_down]['object']['value'],$index[$pos_down]['label']['value'],'previous item') . $button($index[$pos_up]['object']['value'],$index[$pos_up]['label']['value'],'next item');
    }
  }
}

//the bones of this function were lovingly stolen from https://github.com/jonathangreen for his work on islandora_solution_pack_compound
function get_list_isMemberOf($pid){
  $rels_predicate = variable_get('islandora_collection_object_relationship', 'isMemberOf');
  $objects = array();
  $connection = islandora_get_tuque_connection();
  $pid_parts = explode(":", $pid);
  $escaped_pid = str_replace(':', '_', $pid);
  if ($connection) {
    $query = <<<EOQ
  SELECT ?object ?label FROM <#ri>
  WHERE {
    ?object <fedora-model:label> ?label;
            <fedora-rels-ext:isMemberOfCollection> <info:fedora/$pid_parts[0]:collection>
  }
  ORDER BY ?label
EOQ;
 $results = $connection->repository->ri->sparqlQuery($query);
  }
 return $results;
}

?>
